<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Level 3</title>
    <style>
        html, body {
            margin: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        #mycanvas {
            display: block;
            width: 100vw;
            height: 100vh;
            border: 3px solid #ff6a00;
            background-image: url('fire/fire3.jpg');
            background-size: cover;
            background-position: center;
        }

        #hint {
            position: fixed;
            top: 10px;
            left: 10px;
            color: #fff;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 12px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            border-radius: 8px;
            z-index: 20;
        }
    </style>
</head>
<body>
    <div id="hint">Level 3: Final stage - hold click/touch to move</div>

    <audio src="audio/smb3_enter_level.wav" id="levelStart" preload="auto"></audio>
    <audio src="audio/smb3_level_clear.mp3" id="levelFinished" preload="auto"></audio>
    <audio src="audio/smb3_coin.mp3" id="crossEnemy" preload="auto"></audio>
    <audio src="audio/smb_touch.wav" id="touchEnemy" preload="auto"></audio>
    <audio src="audio/smb3_hurry_up.wav" id="timeFinished" preload="auto"></audio>
    <audio src="audio/metroidCut.mp3" id="bg" preload="auto" loop></audio>

    <canvas id="mycanvas"></canvas>

    <script>
        const canvas = document.getElementById('mycanvas');
        const ctx = canvas.getContext('2d');

        const audio = {
            levelStart: document.getElementById('levelStart'),
            levelFinished: document.getElementById('levelFinished'),
            crossEnemy: document.getElementById('crossEnemy'),
            touchEnemy: document.getElementById('touchEnemy'),
            timeFinished: document.getElementById('timeFinished'),
            bg: document.getElementById('bg')
        };

        audio.bg.volume = 0.35;
        audio.crossEnemy.volume = 0.35;

        let gameOver = false;
        let enemyPassed = 0;
        let timer = 550;
        let score = Number(localStorage.getItem('myscore2'));
        if (!Number.isFinite(score)) score = 0;

        let lives = Number(localStorage.getItem('mylives'));
        if (!Number.isFinite(lives) || lives <= 0) lives = 3;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            goal.x = canvas.width - 95;
            goal.y = Math.max(30, (canvas.height / 2) - 40);
        }

        const sprites = {
            player: new Image(),
            goal: new Image(),
            enemy: [new Image(), new Image(), new Image(), new Image(), new Image()]
        };

        sprites.player.src = 'assets/pika.png';
        sprites.goal.src = 'assets/pokeball.png';
        sprites.enemy[0].src = 'fire/Charmeleon2.png';
        sprites.enemy[1].src = 'fire/Magmar2.png';
        sprites.enemy[2].src = 'fire/charizard.png';
        sprites.enemy[3].src = 'fire/Rapidash.png';
        sprites.enemy[4].src = 'fire/growlithe2.png';

        const enemy = [
            { x: 150, y: 10, w: 70, h: 70, speedY: 7 },
            { x: 350, y: 500, w: 70, h: 70, speedY: 8 },
            { x: 600, y: 350, w: 80, h: 80, speedY: 8 },
            { x: 850, y: 510, w: 70, h: 70, speedY: 11 },
            { x: 1050, y: 400, w: 70, h: 70, speedY: 9 }
        ];

        const player = { x: 5, y: 250, w: 50, h: 50, speedX: 4.5, isMoving: false };
        const goal = { x: 0, y: 0, w: 80, h: 80 };

        function playSfx(key) {
            const sound = audio[key];
            sound.currentTime = 0;
            sound.play().catch(() => {});
        }

        function startAudioOnce() {
            playSfx('levelStart');
            audio.bg.play().catch(() => {});
            canvas.removeEventListener('pointerdown', startAudioOnce);
        }

        canvas.addEventListener('pointerdown', () => {
            player.isMoving = true;
            audio.bg.play().catch(() => {});
        });
        canvas.addEventListener('pointerup', () => { player.isMoving = false; });
        canvas.addEventListener('pointerleave', () => { player.isMoving = false; });
        canvas.addEventListener('pointercancel', () => { player.isMoving = false; });
        canvas.addEventListener('pointerdown', startAudioOnce);

        function colliding(r1, r2) {
            return (
                Math.abs(r1.x - r2.x) < Math.max(r1.w, r2.w) * 0.7 &&
                Math.abs(r1.y - r2.y) < Math.max(r1.h, r2.h) * 0.7
            );
        }

        function resetPlayer() {
            player.x = 5;
            player.y = Math.max(20, (canvas.height / 2) - 25);
            player.isMoving = false;
            enemyPassed = 0;
        }

        function loseLifeAndMaybeEnd(reason) {
            lives -= 1;
            localStorage.setItem('mylives', lives);

            if (lives <= 0) {
                localStorage.setItem('mylives', 3);
                audio.bg.pause();
                gameOver = true;
                window.location.assign('6.gameOver.html');
                return;
            }

            if (reason === 'enemy') playSfx('touchEnemy');
            if (reason === 'time') playSfx('timeFinished');
            resetPlayer();
            timer = Math.max(timer, 130);
        }

        function update() {
            const hitEnemy = enemy.some((element) => colliding(element, player));
            if (hitEnemy) {
                loseLifeAndMaybeEnd('enemy');
            }

            if (gameOver) return;

            if (player.x >= goal.x - 15) {
                audio.bg.pause();
                playSfx('levelFinished');
                gameOver = true;
                localStorage.setItem('myscore3', score);
                localStorage.setItem('mylives', lives);
                setTimeout(() => window.location.assign('5.gameEnd.html'), 350);
                return;
            }

            enemy.forEach((element) => {
                element.y += element.speedY;
                if (element.y >= canvas.height - element.h - 5 || element.y <= 5) {
                    element.speedY *= -1;
                }
            });

            if (player.isMoving) {
                player.x += player.speedX;
            }

            while (enemyPassed < enemy.length && player.x > enemy[enemyPassed].x) {
                score += 1;
                playSfx('crossEnemy');
                enemyPassed += 1;
            }

            timer -= 1;
            if (timer <= 0) {
                loseLifeAndMaybeEnd('time');
                timer = 550;
            }
        }

        function drawHud() {
            ctx.strokeStyle = 'red';
            ctx.strokeRect(canvas.width - 200, 10, 180, 120);
            ctx.fillStyle = 'black';
            ctx.fillRect(canvas.width - 200, 10, 180, 120);

            ctx.font = '20px Arial';
            ctx.fillStyle = 'white';
            ctx.fillText('SCORE:', canvas.width - 190, 42);
            ctx.fillStyle = 'deepskyblue';
            ctx.fillText(String(score), canvas.width - 75, 42);

            ctx.fillStyle = 'white';
            ctx.fillText('TIME:', canvas.width - 190, 78);
            ctx.fillStyle = 'red';
            ctx.fillText(String(Math.max(0, timer)), canvas.width - 75, 78);

            ctx.fillStyle = 'white';
            ctx.fillText('LIVES:', canvas.width - 190, 114);
            ctx.fillStyle = 'deeppink';
            ctx.fillText(String(lives), canvas.width - 75, 114);
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            enemy.forEach((element, index) => {
                ctx.drawImage(sprites.enemy[index], element.x, element.y, element.w, element.h);
            });

            ctx.drawImage(sprites.player, player.x, player.y, player.w, player.h);
            ctx.drawImage(sprites.goal, goal.x, goal.y, goal.w, goal.h);
            drawHud();
        }

        function render() {
            draw();
            update();

            if (!gameOver) {
                localStorage.setItem('myscore3', score);
                localStorage.setItem('mylives', lives);
                window.requestAnimationFrame(render);
            }
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        resetPlayer();
        render();
    </script>
</body>
</html>
